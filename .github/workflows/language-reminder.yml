name: Language Reminder

on:
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]
  issues:
    types: [opened]

permissions:
  pull-requests: write
  issues: write
  contents: read
  models: read

jobs:
  check-language:
    name: Check Comment Language
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request || github.event.pull_request

    steps:
      - uses: actions/checkout@v5

      - name: Check language
        id: language_check
        uses: actions/github-script@v8
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        with:
          script: |
            // Use environment variable for security (prevents injection)
            const commentBody = process.env.COMMENT_BODY;

            const response = await fetch('https://models.github.ai/inference/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.GITHUB_TOKEN}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'openai/gpt-4o-mini',
                messages: [
                  {
                    role: 'system',
                    content: 'Determine if a user comment requires a language reminder. This project requires English communication to ensure everyone can participate. Exceptions: very brief comments (1-5 words), comments mixing English with technical native language terms (e.g. "Bundesnetzagentur", "EinspeisevergÃ¼tung"), or uncertain cases should not be flagged. Return true if the comment is predominantly non-English (especially German) and requires a reminder, false otherwise.'
                  },
                  {
                    role: 'user',
                    content: commentBody
                  }
                ],
                response_format: {
                  type: 'json_schema',
                  json_schema: {
                    name: 'language_check',
                    strict: true,
                    schema: {
                      type: 'object',
                      properties: {
                        requires_reminder: { type: 'boolean' }
                      },
                      required: ['requires_reminder'],
                      additionalProperties: false
                    }
                  }
                },
                max_tokens: 200
              })
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Inference failed: ${response.statusText} - ${errorText}`);
            }

            const result = await response.json();
            const analysis = JSON.parse(result.choices[0].message.content);
            core.setOutput('analysis', JSON.stringify(analysis));
            return analysis;

      - name: Post reminder if non-English
        if: steps.language_check.outputs.analysis != ''
        uses: actions/github-script@v8
        with:
          script: |
            const analysis = JSON.parse('${{ steps.language_check.outputs.analysis }}');
            console.log('Analysis:', analysis);

            if (analysis.requires_reminder) {
              const comment = context.payload.comment;
              await github.rest.pulls.createReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                body: `@${comment.user.login} ðŸ‡¬ðŸ‡§ Please use English so everyone can participate. See [Contributing Guidelines](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/master/CONTRIBUTING.md#communication-language).`,
                commit_id: comment.commit_id,
                path: comment.path,
                in_reply_to: comment.id
              });
            }
