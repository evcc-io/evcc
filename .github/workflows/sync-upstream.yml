name: Sync Upstream

on:
  schedule:
    - cron: "0 4 * * *" # Daily at 4 AM UTC
  workflow_dispatch:

jobs:
  sync:
    name: Sync from upstream
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: git remote add upstream https://github.com/evcc-io/evcc.git

      - name: Fetch upstream
        run: git fetch upstream master

      - name: Check for new commits
        id: check
        run: |
          UPSTREAM_COMMITS=$(git rev-list HEAD..upstream/master --count)
          echo "commits=$UPSTREAM_COMMITS" >> $GITHUB_OUTPUT
          echo "Found $UPSTREAM_COMMITS new commits in upstream"

      - name: Check if auth.go was modified upstream
        id: auth_check
        if: steps.check.outputs.commits != '0'
        run: |
          # Get current upstream auth.go hash
          UPSTREAM_HASH=$(git show upstream/master:util/sponsor/auth.go | sha256sum | cut -d' ' -f1)

          # Get stored hash from last sync (if exists)
          STORED_HASH=""
          if [ -f .github/upstream-auth-hash ]; then
            STORED_HASH=$(cat .github/upstream-auth-hash)
          fi

          echo "Upstream hash: $UPSTREAM_HASH"
          echo "Stored hash: $STORED_HASH"

          if [ "$UPSTREAM_HASH" != "$STORED_HASH" ] && [ -n "$STORED_HASH" ]; then
            echo "modified=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è auth.go was modified in upstream since last sync!"
          else
            echo "modified=false" >> $GITHUB_OUTPUT
            # Save current upstream hash for next comparison
            echo "$UPSTREAM_HASH" > .github/upstream-auth-hash
          fi

      - name: Attempt merge
        id: merge
        if: steps.check.outputs.commits != '0'
        run: |
          if git merge upstream/master --no-edit; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=conflict" >> $GITHUB_OUTPUT
            git merge --abort
          fi

      - name: Commit hash file and push
        if: steps.merge.outputs.status == 'success'
        run: |
          # Add hash file if it was updated
          if [ -f .github/upstream-auth-hash ]; then
            git add .github/upstream-auth-hash
            git diff --cached --quiet || git commit --amend --no-edit
          fi
          git push origin master

      - name: Fail on auth.go change
        if: steps.auth_check.outputs.modified == 'true'
        run: |
          echo "::error::üîê auth.go was modified in upstream! Review required."
          echo "Check changes at: https://github.com/evcc-io/evcc/commits/master/util/sponsor/auth.go"
          exit 1

      - name: Fail on conflict
        if: steps.merge.outputs.status == 'conflict'
        run: |
          echo "::error::‚ö†Ô∏è Merge conflict with upstream!"
          echo "Manual resolution required:"
          echo "  git fetch upstream master"
          echo "  git merge upstream/master"
          echo "  # Resolve conflicts (likely in util/sponsor/auth.go)"
          echo "  git push"
          exit 1
