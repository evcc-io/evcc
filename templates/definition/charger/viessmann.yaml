template: viessmann
products:
  - brand: Viessmann
    description:
      generic: Heatpump (SG Ready)
group: heating
requirements:
  # evcc: ["sponsorship"]
  evcc: ["skiptest"]
  description:
    de: |
      Einmalige Warmwasserbereitung auf eine konfigurierbare Solltemperatur. Das Gerät entscheidet eigenständig, ob die Wärmepumpe oder die elektrische Zusatzheizung (falls vorhanden) genutzt wird. 
    en: |
      One-time hot water preparation to a configurable target temperature. The device automatically decides whether to use the heat pump or the auxiliary electric heater (if available).
params:
  - name: user
    required: true
    help:
      de: Registrieren auf https://app.developer.viessmann.com
      en: Register at https://app.developer.viessmann.com
  - name: password
    required: true
    help:
      de: Für den konfigurierten Viessmann Account.
      en: For the configured Viessmann account. 
  - name: clientid
    required: true
    description:
      de: ClientID
      en: ClientID
    help:
      de: Konfigurieren in https://app.developer.viessmann.com
      en: Configure at https://app.developer.viessmann.com
  - name: gateway_serial
    required: true
    description:
      de: Gateway Serial
      en: Gateway Serial
    help:
      de: Seriennummer des VitoConnect modul (VitoCare App -> Einstellungen -> Kommunikationsmodul -> Seriennummer)
      en: VitoConnect serial number (VitoCare App -> Settings -> Communication module -> Serial number)
  - name: installation_id
    required: true
    description:
      de: InstallationID
      en: InstallationID
    help:
      de: siehe https://docs.evcc.io/docs/devices/heating#viessmann
      en: see https://docs.evcc.io/docs/devices/heating#viessmann
  - name: device_id
    required: true
    description:
      de: Device ID - normalerweise `0`
      en: Device ID - typically `0`
    default: 0
  - name: target_temperature
    description:
      de: Zieltemperatur für Einmal-Warmwasser-Zubereitung (°C), max=60
      en: Target temperature for one-time charge (°C), max=60
    required: true
    default: 45
    type: int
  - name: watchdog
    description:
      de: Wie häufig soll neu getriggert werden?
      en: How often should we retrigger?
    type: duration
    default: 3600s
    advanced: true
render: |
  type: sgready
  getmode:
    source: http
    uri: https://api.viessmann.com/iot/v2/features/installations/{{.installation_id}}/gateways/{{.gateway_serial}}/devices/{{.device_id}}/features/heating.dhw.oneTimeCharge
    cache: 2s # to prevent making two identical requests straight after each other for "getmode"
    auth:
      source: viessmann
      user: {{ .user }}
      password: {{ .password }}
      clientid: {{ .clientid }}
    jq: '.data.properties.active.value | if . == false then 1 elif . == true then 2 else . end'
    # false -> oneTimeCharge is disabled -> normal mode -> 1
    # true -> oneTimeCharge is enabled -> boost mode -> 2
  setmode:
    source: watchdog
    timeout: {{ .watchdog }} # re-write at timeout/2
    set:
      source: switch
      switch:
      - case: 1 # normal
        set:
          source: http
          uri: https://api.viessmann.com/iot/v2/features/installations/{{.installation_id}}/gateways/{{.gateway_serial}}/devices/{{.device_id}}/features/heating.dhw.oneTimeCharge/commands/deactivate
          method: POST 
          headers:  
            - content-type: application/json
          auth:
            source: viessmann
            user: {{ .user }}
            password: {{ .password }}
            clientid: {{ .clientid }}
          body: >
            { }
      - case: 2 # boost
        set:
          source: sequence
          set:
          - source: http
            uri: https://api.viessmann.com/iot/v2/features/installations/{{.installation_id}}/gateways/{{.gateway_serial}}/devices/{{.device_id}}/features/heating.dhw.temperature.temp2/commands/setTargetTemperature
            method: POST
            headers:  
              - content-type: application/json
            auth:
              source: viessmann
              user: {{ .user }}
              password: {{ .password }}
              clientid: {{ .clientid }}
            body: >
              {"temperature": {{.target_temperature}}}
          - source: http
            uri: https://api.viessmann.com/iot/v2/features/installations/{{.installation_id}}/gateways/{{.gateway_serial}}/devices/{{.device_id}}/features/heating.dhw.oneTimeCharge/commands/activate
            method: POST 
            headers:  
              - content-type: application/json
            auth:
              source: viessmann
              user: {{ .user }}
              password: {{ .password }}
              clientid: {{ .clientid }}
            body: >
              { }
