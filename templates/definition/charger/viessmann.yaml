template: viessmann
products:
  - brand: Viessmann
    description:
      generic: Heatpump (SG Ready)
group: heating
requirements:
  # evcc: ["sponsorship"]
  evcc: ["skiptest"]
params:
  - name: user
    required: true
  - name: password
    required: true
  - name: clientid
    required: true
    description:
      de: ClientID
      en: ClientID
    help:
      de: https://app.developer.viessmann.com
      en: https://app.developer.viessmann.com
  - name: installation_id # TODO guide user on how to get this value
    required: true
    description:
      de: InstallationID
      en: InstallationID
  - name: gateway_serial # TODO guide user on how to get this value
    required: true
    description:
      de: Gateway Serial
      en: Gateway Serial
  - name: device_id # TODO guide user on how to get this value
    required: true
    description:
      de: Device ID
      en: Device ID
  - name: target_temperature
    description:
      de: Zieltemperatur für Einmal-Warmwasser-Zubereitung (°C), max=60
      en: Target temperature for one-time charge (°C), max=60
    required: true
    default: 45
    type: int
render: |
  type: sgready
  getmode:
    source: http
    uri: https://api.viessmann.com/iot/v2/features/installations/{{.installation_id}}/gateways/{{.gateway_serial}}/devices/{{.device_id}}/features/heating.dhw.oneTimeCharge
    cache: 2s # to prevent making two identical requests straight after each other for "getmode"
    auth:
      source: viessmann
      user: {{ .user }}
      password: {{ .password }}
      clientid: {{ .clientid }}
    jq: '.data.properties.active.value | if . == false then 1 elif . == true then 2 else . end'
    # false -> oneTimeCharge is disabled -> normal mode -> 1
    # true -> oneTimeCharge is enabled -> boost mode -> 2
  setmode:
    source: switch
    switch:
    - case: 1 # normal
      set:
        source: http
        uri: https://api.viessmann.com/iot/v2/features/installations/{{.installation_id}}/gateways/{{.gateway_serial}}/devices/{{.device_id}}/features/heating.dhw.oneTimeCharge/commands/deactivate
        method: POST 
        auth:
          source: viessmann
          user: {{ .user }}
          password: {{ .password }}
          clientid: {{ .clientid }}
        body: >
          { }
    - case: 2 # boost
      set:
        source: sequence
        set:
        - source: http
          uri: https://api.viessmann.com/iot/v2/features/installations/{{.installation_id}}/gateways/{{.gateway_serial}}/devices/{{.device_id}}/features/heating.dhw.temperature.temp2/commands/setTargetTemperature
          method: POST
          auth:
            source: viessmann
            user: {{ .user }}
            password: {{ .password }}
            clientid: {{ .clientid }}
          body: >
            {"temperature": {{.target_temperature}}}
        - source: http
          uri: https://api.viessmann.com/iot/v2/features/installations/{{.installation_id}}/gateways/{{.gateway_serial}}/devices/{{.device_id}}/features/heating.dhw.oneTimeCharge/commands/activate
          method: POST 
          auth:
            source: viessmann
            user: {{ .user }}
            password: {{ .password }}
            clientid: {{ .clientid }}
          body: >
            { }
