template: heishamon
products:
  - brand: Panasonic
    description:
      generic: Heatpump (via Heishamon)
group: heating
requirements:
  # evcc: ["sponsorship"]
  description:
    de: Für Panasonic Wärmepumpen mit Heishamon Platine. Nutzt MQTT und wurde mit Heishamon Software v3.9 getestet. Bei vorhandenem PV-Überschuss wird die Vorlauftemperatur von Zone 1 um den konfigurierten Temperaturoffset angehoben.
    en: For Panasonic heatpumps with Heishamon PCB. Uses MQTT and was tested with Heishamon software v3.9. If PV surplus is available, the temperature of the heatpump in zone 1 is increased by the configured temperature offset.
params:
  - name: heishamon_mqtt_topic
    description:
      de: MQTT Basistopic für Heishamon
      en: MQTT base topic for Heishamon
    default: panasonic_heat_pump
    required: true
    type: string
  - name: dimm_temperature_offset
    description:
      de: Temperaturabsenkung für Dimm Phase
      en: Temperature reduction for dimming phases
    unit: °C
    help:
      de: min. -5°C / max. 0°C
      en: min. -5°C / max. 0°C
    required: true
    default: -2
    type: int
  - name: boost_temperature_offset
    description:
      de: Temperaturerhöhung für Boost Phase
      en: Temperature increase for boost phases
    unit: °C
    help:
      de: min. 0°C / max. +20°C
      en: min. 0°C / max. +20°C
    required: true
    default: 2
    type: int
render: |
  type: sgready
  setmode:
    source: switch
    switch:
      - case: 1 # dimm
        set:
          source: mqtt
          topic: {{.heishamon_mqtt_topic}}/commands/SetZ1HeatRequestTemperature
          payload: {{.dimm_temperature_offset}}
      - case: 2 # normal
        set:
          source: mqtt
          topic: {{.heishamon_mqtt_topic}}/commands/SetZ1HeatRequestTemperature
          payload: 0
      - case: 3 # boost
        set:
          source: mqtt
          topic: {{.heishamon_mqtt_topic}}/commands/SetZ1HeatRequestTemperature
          payload: {{.boost_temperature_offset}}
  getmode:
    source: mqtt
    topic: {{.heishamon_mqtt_topic}}/main/Z1_Heat_Request_Temp
    jq: 'if . < 0 then 1 elif . > 0 then 3 else 2 end'
  temp:
    source: mqtt
    topic: {{.heishamon_mqtt_topic}}/main/Main_Outlet_Temp
  limittemp:
    source: mqtt
    topic: {{.heishamon_mqtt_topic}}/main/Main_Target_Temp
  power:
    source: calc
    add:
      - source: mqtt
        topic: {{.heishamon_mqtt_topic}}/s0/Watt/1
      - source: mqtt
        topic: {{.heishamon_mqtt_topic}}/s0/Watt/2
