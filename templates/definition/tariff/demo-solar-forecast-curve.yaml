template: demo-solar-forecast-curve
products:
  - description:
      de: Demonstrations Solarvorhersage (Glockenkurve)
      en: Demo Solar Forecast (Bell Curve)
requirements:
  description:
    en: For demonstration purposes. Provides realistic solar production curve peaking at noon.
    de: Zu Demonstrationszwecken. Liefert realistische Solarproduktionskurve mit Spitze zur Mittagszeit.
  evcc: ["skiptest"]
group: solar
params:
  - name: peak
    description:
      de: Spitzenleistung zur Mittagszeit
      en: Peak power at noon
    type: float
    unit: W
    default: 4500
    help:
      de: Maximale Solarleistung zur Mittagszeit in Watt
      en: Maximum solar power at noon in watts
  - name: sunrise
    description:
      de: Sonnenaufgang (Stunde)
      en: Sunrise hour
    type: int
    default: 6
    help:
      de: Stunde des Sonnenaufgangs (0-23)
      en: Hour of sunrise (0-23)
  - name: sunset
    description:
      de: Sonnenuntergang (Stunde)
      en: Sunset hour
    type: int
    default: 18
    help:
      de: Stunde des Sonnenuntergangs (0-23)
      en: Hour of sunset (0-23)
  - name: interval
    default: 1h
    advanced: true

render: |
  type: custom
  tariff: solar
  forecast:
    source: js
    script: |
      // Generate realistic solar forecast with bell curve for next 72 hours
      var now = new Date();
      var start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
      var rates = [];
      var peakPower = {{ .peak }};
      var sunrise = {{ .sunrise }};
      var sunset = {{ .sunset }};

      // Calculate day parameters with inclusive hours
      var dayLength = sunset >= sunrise
        ? sunset - sunrise + 1
        : 24 - sunrise + sunset + 1;

      var is24HourDaylight = dayLength === 24;
      var noon = (sunrise + dayLength / 2) % 24;

      // Helper function to calculate distance from noon with wrap-around
      function distanceFromNoon(hour) {
        var diff = Math.abs(hour - noon);
        return Math.min(diff, 24 - diff);
      }

      // Generate hourly rates for 3 days
      for (var day = 0; day < 3; day++) {
        for (var hour = 0; hour < 24; hour++) {
          var time = new Date(start.getTime() + (day * 24 + hour) * 3600000);
          var solarValue = 0;

          if (dayLength > 0) {
            if (is24HourDaylight) {
              // 24-hour daylight: continuous bell curve
              var normalized = distanceFromNoon(hour) / 12;
              solarValue = peakPower * (1 - normalized * normalized * 0.89);
            } else {
              // Regular day: check if within daylight hours
              var isDaylight = sunrise <= sunset
                ? hour >= sunrise && hour <= sunset
                : hour >= sunrise || hour <= sunset;

              if (isDaylight) {
                // Calculate position from sunrise
                var hoursFromSunrise = hour >= sunrise
                  ? hour - sunrise
                  : 24 - sunrise + hour;

                // Bell curve normalized to day length
                var normalized = (hoursFromSunrise - dayLength / 2) / (dayLength / 2);
                solarValue = peakPower * (1 - normalized * normalized);
              }
            }
          }

          rates.push({
            start: time.toISOString(),
            end: new Date(time.getTime() + 3600000).toISOString(),
            value: Math.round(Math.max(0, solarValue))
          });
        }
      }

      JSON.stringify(rates);
  interval: {{ .interval }}
