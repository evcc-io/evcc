template: forecast-victron
products:
  - brand: Victron-VRM
requirements:
  description:
    en: "[vrm.victronenergy.com](https://vrm.victronenergy.com) get the 2-days-forecast from your installation in VRM portal. You need a free user access token."
    de: "[vrm.victronenergy.com](https://vrm.victronenergy.com) abrufen der 2-Tage-Prognose einer Installation im VRM-Portal. Es wird ein kostenloses User Access Token benoetigt."
  evcc: ["skiptest"]
group: solar
params:
  - name: idsite
    description:
      en: VRM-ID of the installation
      de: VRM-ID der Installation
    help:
      en: VRM-ID is shown as VRM Site ID in VRM general settings
      de: VRM-ID wird in den allg. Einstellungen als VRM Site ID in VRM angezeigt
    example: 123456
    required: true
  - name: token
    description:
      en: user access token - create in VRM
      de: user access token - in VRM anlegen
    required: true
  - name: interval
    default: 1h
    advanced: true
render: |
  {{- $n := now -}}
  {{- $start := $n | unixEpoch | int -}}
  {{- $end := add $start 172800 -}}
  {{- $uri := printf "https://vrmapi.victronenergy.com/v2/installations/%s/stats?start=%d&end=%d&interval=hours&type=forecast" .idsite $start $end -}}
  type: custom
  tariff: solar
  forecast:
    source: http
    uri: "{{ $uri }}"
    method: "GET"
    headers:
      - X-Authorization: "Token {{ .token }}"
    jq: |
      .records.solar_yield_forecast | map({
          "start": ((.[0] / 1000) | todateiso8601),
          "end":   (((.[0] + 3600000) / 1000 ) | todateiso8601),
          "value": .[1]
        }) | tostring
  interval: {{ .interval }}
