template: open-meteo
products:
  - brand: OpenMeteo
requirements:
  description:
    en: Free Weather API [open-meteo.com](https://open-meteo.com) Open-Meteo is an open-source weather API and offers free access for non-commercial use. No API key required.
    de: Freie Wetter API [open-meteo.com](https://open-meteo.com) Open-Meteo ist eine Open-Source-Wetter-API und bietet kostenlosen Zugriff für nicht-kommerzielle Nutzung. Kein API-Schlüssel erforderlich.
  evcc: ["skiptest"]
group: solar
params:
  - name: lat
    description:
      en: Latitude
      de: Breitengrad
    example: "55.7351"
    required: true
  - name: lon
    description:
      en: Longitude
      de: Längengrad
    example: "9.1275"
    required: true
  - name: dec
    description:
      en: Decline (tilt) of the solar panel
      de: Winkel (Neigung) des Solarmoduls
    help:
      en: 0 = horizontal, 90 = vertical
      de: 0 = horizontal, 90 = vertikal
    example: 25
    required: true
  - name: az
    description:
      en: Azimuth
      de: Azimut
    help:
      en: -180 = north, -90 = east, 0 = south, 90 = west, 180 = north
      de: -180 = Norden, -90 = Osten, 0 = Süden, 90 = Westen, 180 = Norden
    example: 0
    required: true
  - name: dckwp
    description:
      en: DC-kWp
      de: DC Maximalleistung (kWp)
    example: 9.8
    required: true
  - name: ackwp
    description:
      en: AC-kWp Inverter power
      de: AC Leistung (kW)
    default: 1000
    advanced: true
  - name: dm
    description:
      en: Damping morning (0 = no damping 100 = full damping)
      de: Dämpfung morgens (0 = keine Dämpfung 100 = volle Dämpfung)
    default: 0
    advanced: true
  - name: de
    description:
      en: Damping evening (0 = no damping 100 = full damping)
      de: Dämpfung abends (0 = keine Dämpfung 100 = volle Dämpfung)
    default: 0
    advanced: true
  - name: eff
    description:
      en: Efficiency (0 - 100 = 100% efficiency)
      de: Wirkungsgrad (%)
    default: 100
    advanced: true
  - name: alphatemp
    description:
      en: Temperature coefficient of PV module
      de: Temperaturkoeffizient des PV-Moduls
    example: -0.004
    default: -0.004
    advanced: true
  - name: rossmodel
    description:
      en: Cooling type of PV module (Ross Model)
      de: Kühlung des PV-Moduls (Ross-Modell)
    example: NOT_SO_WELL_COOLED
    type: choice
    default: NOT_SO_WELL_COOLED
    choice:
      - WELL_COOLED
      - FREE_STANDING
      - FLAT_ON_ROOF
      - NOT_SO_WELL_COOLED
      - TRANSPARENT_PV
      - FACADE_INTEGRATED
      - ON_SLOPED_ROOF
    advanced: true
  - name: interval
    default: 1h
    advanced: true
render: |
  type: custom
  tariff: solar
  forecast:
    source: http
    uri: https://api.open-meteo.com/v1/forecast?latitude={{ .lat }}&longitude={{ .lon }}&azimuth={{ .az }}&tilt={{ .dec }}&hourly=temperature_2m,global_tilted_irradiance&daily=sunrise,sunset&forecast_days=3&timezone=auto&timeformat=unixtime
    jq: |
      def alphatemp: {{ .alphatemp }}; # temperature coefficient
      def rossmodel: # cooling type
        if "{{ .rossmodel }}" == "WELL_COOLED" then 0.0200
        elif "{{ .rossmodel }}" == "FREE_STANDING" then 0.0208
        elif "{{ .rossmodel }}" == "FLAT_ON_ROOF" then 0.0260
        elif "{{ .rossmodel }}" == "NOT_SO_WELL_COOLED" then 0.0342
        elif "{{ .rossmodel }}" == "TRANSPARENT_PV" then 0.0455
        elif "{{ .rossmodel }}" == "FACADE_INTEGRATED" then 0.0538
        elif "{{ .rossmodel }}" == "ON_SLOPED_ROOF" then 0.0563
        else 0.0342
        end;
      def eff: {{ .eff }} / 100; # efficiency 1 = 100%
      def dckwp: {{ .dckwp }} * 1000 ; # DC-kWp
      def ackwp: {{ .ackwp }} * 1000 ; # AC-kWp
      def dm: {{ .dm }} / 100; # 1 = 100% damping morning (0 = no damping) 
      def de: {{ .de }} / 100; # damping evening
      def clamp(min; x; max):
        if x < min then min elif x > max then max else x end;
      def midday(sunrise; sunset):
        sunrise + ((sunset - sunrise) / 2);
      def calculate_damping(time; sunrise; sunset; m; e):
        if time < sunrise then m
        elif time < midday(sunrise; sunset) then
          m * (1 - ((time - sunrise) / (midday(sunrise; sunset) - sunrise)))
        elif time < sunset then
          e * ((time - midday(sunrise; sunset)) / (sunset - midday(sunrise; sunset)))
        else
          e
        end;
      .hourly as $h
      | .daily as $d
      | [ range(0; ($h.time | length))
          | . as $i
          | $h.time[$i] as $time
          | ($i / 24 | floor) as $day
          | {
              start: ($time | todateiso8601),
              end: (($time + 3600) | todateiso8601),
              price: (
                dckwp
                * ($h.global_tilted_irradiance[$i] / 1000)
                * (1 + ( alphatemp *
                      (
                        ( ($h.temperature_2m[$i]
                            + ($h.temperature_2m[$i-1] // $h.temperature_2m[$i])
                          ) / 2)
                        + ($h.global_tilted_irradiance[$i] / 800.0) * rossmodel - 25.0
                      )
                    ))
                * (1 - calculate_damping($time;
                      $d.sunrise[$day];
                      $d.sunset[$day];
                      dm; de))
                * eff
                | clamp(0; .; ackwp)
              )
            }
        ]
      | tostring
  interval: {{ .interval }}
