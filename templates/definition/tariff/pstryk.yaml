template: pstryk
products:
  - brand: Pstryk.pl
requirements:
  description:
    en: "Get your API token from the Pstryk App"
    de: "Hol dir deinen API-Token aus der Pstryk App"
  evcc: ["skiptest"]
group: price
countries: ["PL"]

params:
  - name: token
    type: string
    required: true
    description:
      en: "API token (e.g. sk-...)."
      de: "API-Token (z.B. sk-...)."
    help:
      en: "Exact Authorization header value, usually WITHOUT 'Bearer'."
      de: "Exakter Authorization-Header, Ã¼blicherweise OHNE 'Bearer'."

  - name: plan
    type: choice
    default: pricing
    choice: ["pricing", "prosumer-pricing"]
    required: true
    description:
      en: "Tariff source."
      de: "Tarifquelle."

  - preset: tariff-base

render: |
  type: custom
  {{ include "tariff-base" . }}
  forecast:
    source: http
    timeout: 5s
    cache: 24h
    uri: uri: https://api.pstryk.pl/integrations/pricing/?resolution=hour&window_start={{ (dateModify "-24h" now) | dateInZone "2006-01-02" "Europe/Warsaw" }}T{{ if eq (now.Local | date "MST") "CEST" }}22:00:00Z{{ else }}23:00:00Z{{ end }}&window_end={{ if lt (now | dateInZone "15" "Europe/Warsaw") "13" }}{{ now | dateInZone "2006-01-02" "Europe/Warsaw" }}{{ else }}{{ (dateModify "+24h" now) | dateInZone "2006-01-02" "Europe/Warsaw" }}{{ end }}T{{ if eq (now.Local | date "MST") "CEST" }}22:00:00Z{{ else }}23:00:00Z{{ end }}
    headers:
      Authorization: {{ .token }}
      Accept: application/json
      User-Agent: evcc-pstryk-template
    jq: |
      [ (.frames // [])[]
        | { start: (.start | sub("\\+00:00$"; "Z")),
            end:   (.end   | sub("\\+00:00$"; "Z")),
            value: .price_gross }
      ]
