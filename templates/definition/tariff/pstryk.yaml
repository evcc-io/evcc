template: pstryk-pl
products:
  - brand: Pstryk.pl
requirements:
  description:
    en: "Get your API token from the Pstryk App. The template uses a 1h5m refresh interval by default to respect API rate limits."
    de: "Hol dir deinen API-Token aus der Pstryk App. Das Template verwendet standardmäßig ein 1h5m Aktualisierungsintervall, um API-Rate-Limits zu respektieren."
  evcc: ["skiptest"]
group: price
countries: ["PL"]

params:
  - name: token
    type: string
    required: true
    description:
      en: "API token (e.g. sk-...)."
      de: "API-Token (z.B. sk-...)."
    help:
      en: "Exact Authorization header value, usually WITHOUT 'Bearer'."
      de: "Exakter Authorization-Header, üblicherweise OHNE 'Bearer'."

  - name: plan
    type: choice
    default: pricing
    choice: ["pricing", "prosumer-pricing"]
    required: true
    description:
      en: "Tariff source."
      de: "Tarifquelle."

  - name: interval
    default: 1h5m
    advanced: true

  - preset: tariff-base

render: |
  type: custom
  {{ include "tariff-base" . }}
  forecast:
    source: http
    timeout: 10s
    cache: 1h
    uri: https://api.pstryk.pl/integrations/{{ .plan }}/?resolution=hour&window_start={{ `{{ now | mustDateModify "-24h" | date "2006-01-02" }}` }}&window_end={{ `{{ now | mustDateModify "+72h" | date "2006-01-02" }}` }}
    headers:
      Authorization: {{ .token }}
      Accept: application/json
      User-Agent: evcc-pstryk-template
    jq: |
      (.frames // []) as $all
      | ($all[-24:] | map(.price_gross) | add) as $last24_sum
      | ($all[-24:] | length) as $last24_count
      | (if $last24_sum == 0 and $last24_count >= 20
         then $all[:-24]
         else $all
         end) as $filtered
      | [$filtered[]
        | {
          start: (.start | sub("\\+00:00$"; "Z")),
          end: (.end | sub("\\+00:00$"; "Z")),
          value: .price_gross
        }
      ]
  interval: {{ .interval }}
