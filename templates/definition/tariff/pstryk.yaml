template: pstryk-pl
products:
  - brand: Pstryk.pl
requirements:
  description:
    en: "Get your API token from the Pstryk App. IMPORTANT: Add 'interval: 12h' to your tariff config to avoid rate limiting (429 errors)."
    de: "Hol dir deinen API-Token aus der Pstryk App. WICHTIG: Füge 'interval: 12h' zu deiner Tarif-Konfiguration hinzu, um Rate-Limiting (429-Fehler) zu vermeiden."
  evcc: ["skiptest"]
group: price
countries: ["PL"]

params:
  - name: token
    type: string
    required: true
    description:
      en: "API token (e.g. sk-...)."
      de: "API-Token (z.B. sk-...)."
    help:
      en: "Exact Authorization header value, usually WITHOUT 'Bearer'."
      de: "Exakter Authorization-Header, üblicherweise OHNE 'Bearer'."

  - name: plan
    type: choice
    default: pricing
    choice: ["pricing", "prosumer-pricing"]
    required: true
    description:
      en: "Tariff source."
      de: "Tarifquelle."

  - preset: tariff-base

render: |
  type: custom
  {{ include "tariff-base" . }}
  forecast:
    source: http
    timeout: 10s
    cache: 12h
    uri: https://api.pstryk.pl/integrations/{{ .plan }}/?resolution=hour&window_start={{ `{{ dateModify "-24h" now | dateInZone "2006-01-02" "Europe/Warsaw" }}T{{ if eq (dateInZone "MST" "Europe/Warsaw" now) "CEST" }}22:00:00Z{{ else }}23:00:00Z{{ end }}` }}&window_end={{ `{{ dateModify "+48h" now | dateInZone "2006-01-02" "Europe/Warsaw" }}T{{ if eq (dateInZone "MST" "Europe/Warsaw" now) "CEST" }}22:00:00Z{{ else }}23:00:00Z{{ end }}` }}
    headers:
      Authorization: {{ .token }}
      Accept: application/json
      User-Agent: evcc-pstryk-template
    jq: |
      (.frames // []) as $all
      | ($all[-24:] | map(.price_gross) | add) as $last24_sum
      | ($all[-24:] | length) as $last24_count
      | (if $last24_sum == 0 and $last24_count >= 20
         then $all[:-24]
         else $all
         end) as $filtered
      | [$filtered[]
        | {
          start: (.start | sub("\\+00:00$"; "Z")),
          end: (.end | sub("\\+00:00$"; "Z")),
          value: .price_gross
        }
      ]
