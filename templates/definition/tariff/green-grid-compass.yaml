template: green-grid-compass
products:
  - brand: Green Grid Compass
requirements:
  description:
    de: "Europäische CO₂-Intensitätsdaten von [greengrid-compass.eu](https://www.greengrid-compass.eu). Liefert Vorhersagen der nächsten Stunden und ist nach Registrierung kostenlos nutzbar."
    en: "European CO₂ intensity data from [greengrid-compass.eu](https://www.greengrid-compass.eu). Provides forecasts for the next hours and is free of charge after registration."
  evcc: ["skiptest"]
group: co2
countries: ["BE", "DE", "LU"]
params:
  - name: token
    type: string
    required: true
    help:
      de: "Erstelle eine App in https://www.traxes.io/service/green-grid-compass und kopiere den Bearer Token"
      en: "Create an app in https://www.traxes.io/service/green-grid-compass and copy the Bearer token"
  - name: zone
    description:
      de: Zonencode
      en: Zone code
    type: choice
    required: true
    choice: [BE, DE_LU]
    default: DE_LU
render: |
  type: custom
  tariff: co2
  forecast:
    source: http
    uri: https://explore.traxes.io/greengrid-compass/v1/co2-intensity-forecast?start={{ `{{ now | date "2006-01-02T15:04:05Z07:00" }}` }}&end={{ `{{ addDate now 0 0 2 | date "2006-01-02T15:04:05Z07:00" }}` }}&zone={{ .zone }}&time-resolution=Hourly&calculation-type=Consumption&emission-type=Operational&forecast-type=Actual
    auth:
      type: bearer
      token: {{ .token }}
    jq: |
      .measurements[0].measurementValues | map({ 
        "start": .timestamp,
        "end": (.timestamp | strptime("%Y-%m-%dT%H:%M:%SZ") | mktime + 3600 | strftime("%Y-%m-%dT%H:%M:%SZ")),
        "value": .value 
      }) | tostring
    cache: 1h
