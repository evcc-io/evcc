template: marstek-venus
products:
  - brand: Marstek
    description:
      generic: Venus Battery Storage
capabilities: ["battery-control"]
requirements:
  description:
    en: >
      Requires a Modbus TCP gateway (e.g., PUSR USR-DR134). Tested with firmware version V151.
      Settings: Baud Rate 115200, Data Bits 8, Stop Bits 1, Parity None, TCP Server.
    de: >
      Erfordert ein Modbus-TCP-Gateway (z. B. PUSR USR-DR134). Getestet mit Firmware-Version V151.
      Settings: Baud Rate 115200, Data Bits 8, Stop Bits 1, Parity None, TCP Server.
  evcc: ["skiptest"]
params:
  - name: uri
    required: true
    description:
      en: Ip address and port of the Modbus TCP gateway.
      de: IP-Adresse und Port des Modbus-TCP-Gateways.
    example: "192.168.0.8:502"
  - name: capacity
    default: 5.12
    description:
      de: Batteriekapazität in kWh. Venus-E 5.12, Venus-C 2.56
      en: Battery capacity in kWh. Venus-E 5.12, Venus-C 2.56
  - name: id
    default: 1
    advanced: true
    description:
      en: Slave ID of the Modbus device.
      de: Slave-ID des Modbus-Geräts.
  - name: minsoc
    default: 11
    type: int
    advanced: true
    description:
      de: Venus kann nur bis 11% entladen werden.
      en: Venus can only be discharged down to 11%.
  - name: maxsoc
    default: 100
    type: int
    advanced: true
  - name: maxchargepower
  - name: work_mode_normal
    default: 1
    advanced: true
    description:
      en: Work mode for Normal state. 0 manual, 1 anti-feed, 2 trade mode.
      de: Work mode für Normal-Modus. 0 Manueller Modus, 1 Eigenverbrauch, 2 AI-Optimierung.
render: |
  type: custom
  power:
    source: modbus
    uri: {{ .uri }}
    id: {{ .id }}
    register:
      address: 32202 # AC Power (Watt)
      type: holding
      decode: int32
    scale: 1
  energy:
    source: modbus
    uri: {{ .uri }}
    id: {{ .id }}
    register:
      address: 33000 # Total Charging Energy (kWh)
      type: holding
      decode: uint32
    scale: 0.01
  soc:
    source: modbus
    uri: {{ .uri }}
    id: {{ .id }}
    register:
      address: 32104 # Battery SOC (%)
      type: holding
      decode: uint16
    scale: 1
  batterymode:
    source: switch
    switch:
    - case: 1 # normal
      set:
        source: sequence
        set:
        - source: const
          value: 21930
          set:
            source: modbus
            uri: {{ .uri }}
            id: {{ .id }}
            register:
              address: 42000 # RS485 Control Mode = Enabled
              type: writesingle
              decode: uint16
        - source: const
          value: {{ .work_mode_normal }}
          set:
            source: modbus
            uri: {{ .uri }}
            id: {{ .id }}
            register:
              address: 43000 # User Work Mode
              type: writesingle
              decode: uint16
        - source: const
          value: 21947
          set:
            source: modbus
            uri: {{ .uri }}
            id: {{ .id }}
            register:
              address: 42000 # RS485 Control Mode = Disabled
              type: writesingle
              decode: uint16
    - case: 2 # hold
      set:
        source: sequence
        set:
        - source: const
          value: 21930
          set:
            source: modbus
            uri: {{ .uri }}
            id: {{ .id }}
            register:
              address: 42000 # RS485 Control Mode = Enabled
              type: writesingle
              decode: uint16
        - source: const
          value: 0
          set:
            source: modbus
            uri: {{ .uri }}
            id: {{ .id }}
            register:
              address: 42010 # Force Charge/Discharge = Stop
              type: writesingle
              decode: uint16
    - case: 3 # charge
      set:
        source: sequence
        set:
        - source: const
          value: 21930
          set:
            source: modbus
            uri: {{ .uri }}
            id: {{ .id }}
            register:
              address: 42000 # RS485 Control Mode = Enabled
              type: writesingle
              decode: uint16
        - source: const
          value: 1
          set:
            source: modbus
            uri: {{ .uri }}
            id: {{ .id }}
            register:
              address: 42010 # Force Charge/Discharge = Charge
              type: writesingle
              decode: uint16
        - source: const
          value: {{ .maxchargepower }}
          set:
            source: modbus
            uri: {{ .uri }}
            id: {{ .id }}
            register:
              address: 42020 # Forcible Charge Power
              type: writesingle
              decode: uint16
  capacity: {{ .capacity }} # kWh
