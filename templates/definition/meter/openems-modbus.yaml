template: openems-modbus
products:
  - brand: OpenEMS (Modbus)
  - brand: FENECON (Modbus)
capabilities: ["battery-control"]
requirements:
  description:
    de: |
      Für FEMS FENECON-Systeme ist eine kommerzielle Lizenz für die aktive Batteriesteuerung erforderlich (Modbus-API).
    en: |
      A commercial license is required for FEMS FENECON systems for active battery control (Modbus-API).
params:
  - name: usage
    choice: ["grid", "pv", "battery"]
    allinone: true
  - name: host
  - name: modbusid
    advanced: true
  - name: port
    default: 502
    advanced: true
  - name: grid_power_register
    type: int
    default: 315
    description:
      de: Modbus-Register für Netzleistung
      en: Modbus register for grid power
    help:
      generic: GridActivePower (W)
    usages: ["grid"]
    advanced: true
  - name: grid_energy_register
    type: int
    default: 359
    description:
      de: Modbus-Register für Netzbezug Energie
      en: Modbus register for grid import energy
    help:
      generic: GridBuyActiveEnergy (Wh)
    usages: ["grid"]
    advanced: true
  - name: pv_power_register
    type: int
    default: 327
    description:
      de: Modbus-Register für PV-Leistung
      en: Modbus register for PV power
    help:
      generic: ProductionActivePower (W)
    usages: ["pv"]
    advanced: true
  - name: pv_energy_register
    type: int
    default: 367
    description:
      de: Modbus-Register für PV-Energie
      en: Modbus register for PV energy
    help:
      generic: ProductionActiveEnergy (Wh)
    usages: ["pv"]
    advanced: true
  - name: battery_power_register
    type: int
    default: 415
    description:
      de: Modbus-Register für Batterie-Leistung
      en: Modbus register for battery power
    help:
      generic: EssDischargePower (W)
    usages: ["battery"]
    advanced: true
  - name: battery_soc_register
    type: int
    default: 302
    description:
      de: Modbus-Register für Batteriestand
      en: Modbus register for state of charge
    help:
      generic: SoC (%)
    usages: ["battery"]
    advanced: true
  - name: battery_set_register
    type: int
    default: 710
    description:
      de: Modbus-Register für Ladeleistung
      en: Modbus register for charge power
    help:
      generic: SetActivePowerLessOrEquals (W)
    usages: ["battery"]
    advanced: true
  - name: battery
    type: bool
    default: false
    description:
      de: Aktiviert Schreibzugriffe (Batteriesteuerung)
      en: Enables write access (battery control)
    usages: ["battery"]
    advanced: true
  - name: watchdog
    type: duration
    default: 60s
    help:
      de: abgestimmt auf das API-Timeout
      en: adjusted to the API timeout
    usages: ["battery"]
    advanced: true
  - name: minsoc
    advanced: true
  - name: maxsoc
    advanced: true
  - name: capacity
    advanced: true
  - name: maxchargepower
  - name: maxdischargepower
  - name: maxacpower
render: |
  type: custom
  {{- if eq .usage "grid" }} 
  power:
    source: modbus
    id: {{ .modbusid }}
    uri: {{ .host }}:{{ .port }}
    register:
      address: {{ .grid_power_register }} # GridActivePower (W)
      type: input
      encoding: float32
  energy:
    source: modbus
    id: {{ .modbusid }}
    uri: {{ .host }}:{{ .port }}
    register:
      address: {{ .grid_energy_register }} # GridBuyActiveEnergy (Wh)
      type: holding
      encoding: float64
    scale: 0.001 # Wh -> kWh
  {{- end }}
  {{- if eq .usage "pv" }}
  power:
    source: modbus
    id: {{ .modbusid }}
    uri: {{ .host }}:{{ .port }}
    register:
      address: {{ .pv_power_register }} # ProductionActivePower (W)
      type: input
      encoding: float32
  energy:
    source: modbus
    id: {{ .modbusid }}
    uri: {{ .host }}:{{ .port }}
    register:
      address: {{ .pv_energy_register }} # ProductionActiveEnergy (Wh)
      type: holding
      encoding: float64
    scale: 0.001 # Wh -> kWh
  maxacpower: {{ .maxacpower }} # W
  {{- end }}
  {{- if eq .usage "battery" }}
  power:
    source: modbus
    id: {{ .modbusid }}
    uri: {{ .host }}:{{ .port }}
    register:
      address: {{ .battery_power_register }} # EssDischargePower (W)
      type: input
      encoding: float32
  soc:
    source: modbus
    id: {{ .modbusid }}
    uri: {{ .host }}:{{ .port }}
    register:
      address: {{ .battery_soc_register }} # EssSoc (%)
      type: input
      encoding: uint16
  {{- if .battery }}
  batterymode:
    source: watchdog
    timeout: {{ .watchdog }} # re-write at timeout/2
    reset: 1
    set:
      source: switch
      switch:
      - case: 1 # normal
        set:
          source: const
          value: 0
          set:
            source: modbus
            id: {{ .modbusid }}
            uri: {{ .host }}:{{ .port }}
            register:
              address: {{ .battery_set_register }} # SetActivePowerLessOrEquals (W)
              type: writemultiple
              encoding: float32
      - case: 2 # hold
        set:
          source: const
          value: 0
          set:
            source: modbus
            id: {{ .modbusid }}
            uri: {{ .host }}:{{ .port }}
            register:
              address: {{ .battery_set_register }}
              type: writemultiple
              encoding: float32
      - case: 3 # charge
        set:
          source: const
          value: {{ mul .maxchargepower -1 }} # charge power is negative
          set:
            source: modbus
            id: {{ .modbusid }}
            uri: {{ .host }}:{{ .port }}
            register:
              address: {{ .battery_set_register }}
              type: writemultiple
              encoding: float32
  {{- end }}
  minsoc: {{ .minsoc }} # %
  maxsoc: {{ .maxsoc }} # %
  maxchargepower: {{ .maxchargepower }} # W
  maxdischargepower: {{ .maxdischargepower }} # W
  capacity: {{ .capacity }} # kWh
  {{- end }}
