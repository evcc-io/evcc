template: solis-hybrid-s
products:
  - brand: Ginlong
    description:
      generic: Solis Hybrid Inverter (S Series)
  - brand: Ginlong
    description:
      generic: Solis Storage Inverter (S Series)
  - brand: Axitec
    description:
      generic: AXIhycon 12-15H
capabilities: ["battery-control"]
requirements:
  description:
    de: |
      Die aktive Batteriesteuerung überschreibt die Wechselrichter Einstellungen "Allow grid charging" und "Battery Reserve SOC".
      Der Parameter "Netzladen im Hold-Modus erlauben" (gridchargeonhold, Standard: false) bestimmt, ob "Allow grid charging" aktiviert bleibt wenn der Max. SOC Wert erreicht ist.
      Dies ist für Umgebungen mit mehreren Wechselrichtern parallel zum Solis Inverter gedacht, in denen der Solis Inverter den
      Überschuss der anderen Inverter in seine Batterie laden soll. Eine Ladung aus dem öffentlichen Netz über den Max. SOC hinaus erfolgt dabei nicht.
    en: |
      Active battery control overrides the inverter settings "Allow grid charging" and "Battery Reserve SOC".
      The "Keep grid charging on in hold mode" (gridchargeonhold, default: false) determines whether "Allow grid charging" remains enabled when the Max. SOC value is reached.
      This is intended for environments with multiple inverters parallel to the Solis inverter, where the Solis inverter should
      charge its battery from the surplus of the other inverters. Charging from the public grid beyond Max. SOC will not occur.
params:
  - name: usage
    choice: ["grid", "pv", "battery"]
  - name: modbus
    choice: ["rs485"]
    baudrate: 9600
    id: 1
  - name: maxacpower
  - preset: battery-params
  - name: gridchargeonhold
    default: false
    type: bool
    description:
      en: Keep grid charging on in hold mode
      de: Netzladen im Hold-Modus erlauben
render: |
  type: custom
  {{- if eq .usage "grid" }}
  power:
    source: modbus
    {{- include "modbus" . | indent 2 }}
    register:
      address: 33263 # Meter total active power
      type: input
      decode: int32nan
    scale: -1
  energy:
    source: modbus
    {{- include "modbus" . | indent 2 }}
    register:
      address: 33283 # Meter total active energy from grid
      type: input
      decode: uint32
    scale: 0.01
  currents:
  - source: modbus
    {{- include "modbus" . | indent 2 }}
    register:
      address: 33252 # Meter ac current A
      type: input
      decode: uint16
    scale: 0.01
  - source: modbus
    {{- include "modbus" . | indent 2 }}
    register:
      address: 33254 # Meter ac current B
      type: input
      decode: uint16
    scale: 0.01
  - source: modbus
    {{- include "modbus" . | indent 2 }}
    register:
      address: 33256 # Meter ac current C
      type: input
      decode: uint16
    scale: 0.01
  powers:
  - source: modbus
    {{- include "modbus" . | indent 2 }}
    register:
      address: 33257 # Meter active power A
      type: input
      decode: int32
    scale: -1
  - source: modbus
    {{- include "modbus" . | indent 2 }}
    register:
      address: 33259 # Meter active power B
      type: input
      decode: int32
    scale: -1
  - source: modbus
    {{- include "modbus" . | indent 2 }}
    register:
      address: 33261 # Meter active power C
      type: input
      decode: int32
    scale: -1
  {{- end }}
  {{- if eq .usage "pv" }}
  power:
    source: modbus
    {{- include "modbus" . | indent 2 }}
    register:
      type: input
      address: 33057 # Total DC output power (PV Power)
      decode: uint32
  energy:
    source: modbus
    {{- include "modbus" . | indent 2 }}
    register:
      address: 33029 # Total energy generation
      type: input
      decode: uint32
  maxacpower: {{ .maxacpower }} # W
  {{- end }}
  {{- if eq .usage "battery" }}
  power:
    source: calc
    mul:
    - source: modbus
      {{- include "modbus" . | indent 4 }}
      register:
        type: input
        address: 33149 # Battery power
        decode: uint32
    - source: calc
      add:
      - source: modbus
        {{- include "modbus" . | indent 6 }}
        register:
          type: input
          address: 33135 # Battery current direction
          decode: uint16 # 0: charge, 1: discharge
        scale: 2
      - source: const
        value: -1
  energy:
    source: modbus
    {{- include "modbus" . | indent 2 }}
    register:
      address: 33165 # Battery total discharge energy
      type: input
      decode: uint32
  soc:
    source: modbus
    {{- include "modbus" . | indent 2 }}
    register:
      address: 33139 # Battery capacity SOC
      type: input
      decode: uint16
  batterymode:
    source: switch
    switch:
    - case: 1  # normal
      set:
        source: sequence
        set:
        - source: const
          value: {{ .minsoc }}
          set:
            source: modbus
            {{- include "modbus" . | indent 10 }}
            register:
              address: 43024 # Battery Reserve SOC
              type: writeholding
              decode: uint16
        - source: const
          value: 48 # Bits 4+5: Battery Reserve (16) + Allow Grid Charge (32)
          set:
            source: modbus
            {{- include "modbus" . | indent 10 }}
            register:
              address: 43110
              type: writeholding
              decode: uint16
    - case: 2  # hold
      set:
        source: sequence
        set:
        - source: const
          value: {{ .maxsoc }}
          set:
            source: modbus
            {{- include "modbus" . | indent 10 }}
            register:
              address: 43024 # Battery Reserve SOC
              type: writeholding
              decode: uint16
        - source: const
          {{- if .gridchargeonhold }}
          value: 48 # Bits 4+5: Battery Reserve (16) + Allow Grid Charge (32)
          {{- else }}
          value: 16 # Bit 4 only: Battery Reserve (16)
          {{- end }}
          set:
            source: modbus
            {{- include "modbus" . | indent 10 }}
            register:
              address: 43110
              type: writeholding
              decode: uint16
    - case: 3  # charge
      set:
        source: sequence
        set:
        - source: const
          value: {{ .maxsoc }}
          set:
            source: modbus
            {{- include "modbus" . | indent 10 }}
            register:
              address: 43024 # Battery Reserve SOC
              type: writeholding
              decode: uint16
        - source: const
          value: 48 # Bits 4+5: Battery Reserve (16) + Allow Grid Charge (32)
          set:
            source: modbus
            {{- include "modbus" . | indent 10 }}
            register:
              address: 43110
              type: writeholding
              decode: uint16
  {{- include "battery-params" . }}
  {{- end }}
