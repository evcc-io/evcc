<template>
	<div class="strategy-wrapper" :class="{ open: show }">
		<div class="strategy-content">
			<div class="row">
				<div class="col-12 col-sm-6 col-lg-3 offset-lg-3 mb-3">
					<div class="row">
						<label :for="formId('continuous')" class="col-form-label col-5 col-sm-12"
							>Optimierung</label
						>
						<div class="col-7 col-sm-12">
							<select
								:id="formId('continuous')"
								v-model="localContinuous"
								class="form-select"
								data-testid="plan-strategy-continuous"
								@change="updateStrategy"
							>
								<option :value="false">günstig</option>
								<option :value="true">durchgehend</option>
							</select>
						</div>
					</div>
				</div>
				<div class="col-sm-6 col-lg-3 mb-3">
					<div class="row">
						<label :for="formId('precondition')" class="col-form-label col-5 col-sm-12"
							>Spätes Laden</label
						>
						<div class="col-7 col-sm-12">
							<select
								:id="formId('precondition')"
								v-model="localPrecondition"
								class="form-select"
								data-testid="plan-strategy-precondition"
								@change="updateStrategy"
							>
								<option :value="0">
									{{ $t("main.chargingPlan.preconditionOptionNo") }}
								</option>
								<option
									v-for="opt in preconditionOptions"
									:key="opt.value"
									:value="opt.value"
								>
									{{ opt.name }}
								</option>
							</select>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</template>

<script lang="ts">
import { defineComponent } from "vue";
import formatter from "@/mixins/formatter";
import type { PlanStrategy } from "./types";

export default defineComponent({
	name: "ChargingPlanStrategy",
	mixins: [formatter],
	props: {
		id: [String, Number],
		show: Boolean,
		precondition: { type: Number, default: 0 },
		continuous: { type: Boolean, default: false },
	},
	emits: ["update"],
	data() {
		return {
			localPrecondition: this.precondition,
			localContinuous: this.continuous,
		};
	},
	computed: {
		preconditionOptions() {
			const HOUR = 60 * 60;
			const QUARTER_HOUR = 0.25 * HOUR;
			const HALF_HOUR = 0.5 * HOUR;
			const ONE_HOUR = 1 * HOUR;
			const TWO_HOURS = 2 * HOUR;
			const EVERYTHING = 7 * 24 * HOUR;

			const options = [QUARTER_HOUR, HALF_HOUR, ONE_HOUR, TWO_HOURS, EVERYTHING];

			// support custom values (via API)
			if (this.localPrecondition && !options.includes(this.localPrecondition)) {
				options.push(this.localPrecondition);
			}

			return options.map((s) => ({
				value: s,
				name:
					s === EVERYTHING
						? this.$t("main.chargingPlan.preconditionOptionAll")
						: this.fmtDurationLong(s),
			}));
		},
	},
	watch: {
		precondition: {
			handler(newValue: number, oldValue: number) {
				// Only update if value actually changed from external source
				if (newValue !== this.localPrecondition) {
					this.localPrecondition = newValue;
				}
			},
			immediate: true,
		},
		continuous: {
			handler(newValue: boolean, oldValue: boolean) {
				// Only update if value actually changed from external source
				if (newValue !== this.localContinuous) {
					this.localContinuous = newValue;
				}
			},
			immediate: true,
		},
	},
	methods: {
		formId(name: string) {
			return `chargingplan-${this.id}-${name}`;
		},
		updateStrategy(): void {
			const strategy: PlanStrategy = {
				continuous: this.localContinuous,
				precondition: this.localPrecondition,
			};
			this.$emit("update", strategy);
		},
	},
});
</script>

<style scoped>
.strategy-wrapper {
	display: grid;
	grid-template-rows: 0fr;
	margin-bottom: 0;
	transition:
		grid-template-rows 0.3s ease 0.2s,
		margin-bottom 0.3s ease 0.2s;
}

.strategy-wrapper.open {
	grid-template-rows: 1fr;
	margin-bottom: 1rem;
	transition:
		grid-template-rows 0.3s ease,
		margin-bottom 0.3s ease;
}

.strategy-content {
	overflow: hidden;
	opacity: 0;
	transition: opacity 0.2s ease;
}

.open .strategy-content {
	opacity: 1;
	transition: opacity 0.3s ease 0.2s;
}
</style>